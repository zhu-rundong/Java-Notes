# 缓存雪崩

## 是什么

> 大量的应用请求无法在 Redis 中处理，紧接着，应用将大量请求发送到数据库层，导致数据库层的压力激增。

## 解决方案

缓存雪崩一般是由两个原因导致的，不同的原因处理方案也有所不同。

**第一个原因：缓存中大量数据同时过期，导致大量请求无法得到处理。针对这种情况，一般有两种解决方案：**

1. **过期时间 + 随机数**

    > 首先，我们要避免给大量的数据设置相同的过期时间。如果业务层的确要求有些数据同时失效，可以使用 **EXPIRE** 命令给每个数据设置过期时间时，给这些数据的过期时间增加一个较小的随机数（例如，随机增加 1~3 分钟），这样一来，不同数据的过期时间有所差别，但差别又不会太大，既避免了大量数据同时过期，同时也保证了这些数据基本在相近的时间失效，仍然能满足业务需求。
    >
2. **服务降级**

    > 所谓的服务降级，是指发生缓存雪崩时，针对不同的数据采取不同的处理方式。也就是允许核心数据访问数据库，非核心数据直接返回预定义信息。例如访问商品库存，仍然允许查询缓存，如果缓存缺失，也可以继续通过数据库读取；但是对于商品的一些其他属性，可以暂时停止从缓存中查询这些数据，而是直接返回预定义信息、空值或是错误信息。
    >

**第二个原因：Redis 缓存实例发生故障宕机了，无法处理请求。针对这种情况，一般也有两种解决方案：**

1. **业务系统中实现服务熔断或请求限流机制**

    **服务熔断：**

    > 在发生缓存雪崩时，为了防止引发连锁的数据库雪崩及系统崩溃，暂停业务应用对缓存系统的接口访问。也就是业务应用调用缓存接口时，缓存客户端并不把请求发给 Redis 缓存实例，而是直接返回，等到 Redis 缓存实例重新恢复服务后，再允许应用请求发送到缓存系统。
    >

    **启动熔断：**

    > 我们可以监测 Redis 缓存所在机器和数据库所在机器的负载指标，例如每秒请求数、CPU 利用率、内存利用率等。如果发现 Redis 缓存实例宕机了，而数据库所在机器的负载压力突然增加（例如每秒请求数激增），此时，就发生缓存雪崩了，大量请求被发送到数据库进行处理。这时，我们可以启动服务熔断机制，暂停业务应用对缓存服务的访问，从而降低对数据库的访问压力。
    >

    **熔断恢复：**

    > 当进入熔断状态，一段时间之后允许少量请求通过，如果请求都执行成功，则退出熔断状态，如果请求仍旧失败，在下一个时间段，再次允许少量请求通过，试探服务是否恢复。
    >

    服务熔断暂停了整个缓存系统的访问，对业务应用的影响范围较大。为了尽可能减少这种影响，我们也可以进行请求限流。

    **请求限流:**

    > 在业务系统的请求入口前端控制每秒进入系统的请求数，避免过多的请求被发送到数据库。
    >
    > 假设业务系统正常运行时，请求入口前端允许每秒进入系统的请求是 1 万个，其中，9000 个请求都能在缓存系统中进行处理，只有 1000 个请求会被应用发送到数据库进行处理。
    >
    > 一旦发生了缓存雪崩，数据库的每秒请求数突然增加到每秒 1 万个，此时，我们就可以启动请求限流机制，在请求入口前端只允许每秒进入系统的请求数为 1000 个，再多的请求就会在入口前端被直接拒绝服务。所以，使用了请求限流，就可以避免大量并发请求压力传递到数据库层。
    >
2. **缓存集群实现高可用**

    使用服务熔断和请求限流机制，属于已经发生缓存雪崩了，我们使用这两个机制，主要是来降低雪崩对数据库和整个业务系统的影响。此外，我们还可以事先预防。

    > 通过主从节点的方式构建 Redis 缓存高可靠集群。如果 Redis 缓存的主节点故障宕机了，从节点还可以切换成为主节点，继续提供缓存服务，避免了由于缓存实例宕机而导致的缓存雪崩问题。
    >
